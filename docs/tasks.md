# KAR 任务追踪

> 本文件记录具体可执行的任务，按优先级排序。

---

## 🔴 当前阶段：Phase 2 - 鲁棒性与用户体验

### 高优先级任务

| 序号 | 任务 | 状态 | 说明 |
|-----|------|-----|------|
| 2.1 | 实现 CRC32 校验和计算 | ✅ | 使用自研查表法，见 `crc32.hpp` |
| 2.2 | 打包时写入 CRC32 到 EntryHeader | ✅ | 修改 `write_entry()` 方法 |
| 2.3 | 解包时验证 CRC32 | ✅ | 校验失败时抛出异常 |
| 2.4 | 修复 modified_time 保存逻辑 | 🚧 | 当前使用当前时间，应使用文件实际 mtime |

### 中优先级任务

| 序号 | 任务 | 状态 | 说明 |
|-----|------|-----|------|
| 2.5 | 添加打包进度条 | ✅ | 基于文件数量，30字符宽度进度条 |
| 2.6 | 添加解包进度条 | ✅ | 基于文件数量，30字符宽度进度条 |
| 2.7 | 实现增量追加功能 `--append` | ⬜ | 支持向现有 archive 追加文件 |

### 低优先级任务

| 序号 | 任务 | 状态 | 说明 |
|-----|------|-----|------|
| 2.8 | 符号链接处理 | ⬜ | 决定是跟随链接还是保存链接本身 |
| 2.9 | 错误信息国际化 | ⬜ | 中文错误提示 |

---

## 🟡 下一阶段：Phase 3 - 性能优化

> 前置条件：Phase 2 全部完成

| 序号 | 任务 | 状态 | 说明 |
|-----|------|-----|------|
| 3.1 | 搭建性能测试框架 | ⬜ | 使用 std::chrono 计时 |
| 3.2 | 设计测试场景 | ⬜ | 小文件密集、中等文件、大文件 |
| 3.3 | 执行基准测试 | ⬜ | 记录当前性能数据 |
| 3.4 | 分析性能瓶颈 | ⬜ | 确定是 IO 瓶颈还是 CPU 瓶颈 |
| 3.5 | 实现写入合并优化 | ⬜ | 减少 write() 系统调用次数 |
| 3.6 | 实现缓冲区预分配 | ⬜ | 避免 vector 重复扩容 |
| 3.7 | 评估压缩算法 | ⬜ | 调研 LZ4 / zstd / 自定义 Huffman |

---

## 🟢 远期规划：Phase 4 - 并行化

> ⚠️ 前置条件：基准测试证明存在 CPU 瓶颈，且目标场景以 SSD 为主

| 序号 | 任务 | 状态 | 说明 |
|-----|------|-----|------|
| 4.1 | 设计并行化方案评审 | ⬜ | 参考 `parallel_archive_design.md`，评估是否实施 |
| 4.2 | 实现 ThreadSafeQueue | ⬜ | 线程安全任务队列 |
| 4.3 | 实现 ThreadPool | ⬜ | 固定大小线程池 |
| 4.4 | 实现 Pack 并行计算 | ⬜ | 仅并行 CRC32/压缩，写入串行 |
| 4.5 | 实现内存限制器 | ⬜ | 防止并发读取大文件导致 OOM |

---

## ✅ 已完成任务

| 序号 | 任务 | 完成时间 | 说明 |
|-----|------|---------|------|
| 1.1 | 定义 .kar 文件格式协议 | - | magic + version + entry_count |
| 1.2 | 实现 pack 命令 | - | 递归打包目录 |
| 1.3 | 实现 unpack 命令 | - | 还原目录结构 |
| 1.4 | 实现 list 命令 | - | 查看归档内容 |

---

## 📋 Review 记录

### 2026-02-18: 并行化设计文档 Review

**Review 结论**：`parallel_archive_design.md` 设计思路专业，但实施时机不成熟。

**主要意见**：
1. 当前为过早优化，应先完成 Phase 2 基础功能
2. 并行化收益需基于基准测试数据，当前假设过于乐观
3. Unpack 并行设计存在缺陷（HDD 寻道问题）
4. 技术栈选择（mmap/aio/io_uring）牺牲可移植性

**决策**：并行化移至 Phase 4，设置明确前置条件。

**下一步行动**：
- 聚焦 Phase 2 任务（CRC32、进度条、增量更新）
- 建立性能基准测试框架
- 用数据驱动后续优化决策
