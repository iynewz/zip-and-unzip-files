# KAR (Kimi Archive) 产品需求文档

## 项目概述

KAR 是一个轻量级命令行归档工具，支持将目录结构打包为自定义二进制格式（.kar），并保持文件权限和目录结构。

---

## 发展阶段规划

### Phase 1: 基础 Archive ✅ 已完成
- [x] 定义文件格式协议：设计二进制 header 结构
- [x] 序列化/反序列化：将多个文件打包成单一二进制文件
- [x] 目录遍历：递归处理子文件夹
- [x] 解包功能：从 archive 还原文件结构

### Phase 2: 鲁棒性与用户体验 🚧 当前阶段

#### 2.1 数据完整性（高优先级）
- CRC32 校验和计算与验证
- 解包时自动校验文件完整性
- 损坏文件的友好错误提示

#### 2.2 进度显示（中优先级）
- 打包/解包时显示实时进度条
- 显示处理速度（MB/s）
- 预计剩余时间

#### 2.3 增量更新（中优先级）
- 支持向现有 archive 追加文件
- `pack --append` 命令支持

#### 2.4 元数据完善（低优先级）
- 正确保存/恢复文件修改时间（mtime）
- 支持符号链接处理

### Phase 3: 性能优化（待评估）

> ⚠️ **重要**：本阶段需基于 Phase 2 完成后的性能基准测试数据决定是否实施。

#### 3.1 性能基准测试
- ✅ 建立可重复的性能测试框架
  - `make test-data`: 自动生成测试数据
  - `make benchmark`: 执行完整打包/解包/验证流程
  - `scripts/generate_test_data.py`: Python 脚本支持自定义参数
- ✅ 覆盖不同场景：小文件密集、大文件、混合场景
  - 小文件场景：100+ 个 1-10 KB 文件
  - 中等文件：20 个 100 KB - 1 MB 文件
  - 大文件场景：5 个 5-20 MB 文件
  - 深层目录：10 层嵌套目录结构
  - 混合场景：模拟真实项目结构
- ✅ 执行基准测试并保存结果
  - 结果保存到 `benchmark_results.txt`（已加入 .gitignore）
  - 包含测试时间、文件数量、数据大小、打包/解包耗时 (real/user/sys)
  - 支持两种模式：标准模式 (~80MB) 和压力模式 (~500MB-1GB)
  - 用于后续压缩功能性能对比
- 测试不同存储介质（SSD/HDD）表现

#### 3.2 针对性优化（无锁、低复杂度）
- 减少系统调用次数（合并写入操作）
- 预分配缓冲区，减少内存拷贝
- 文件读取缓冲区优化

#### 3.3 压缩支持（可选）
- 调研压缩算法对性能的影响
- Huffman 编码或 LZ4 快速压缩
- 支持压缩级别配置

### Phase 4: 并行化（远期规划）

> ⚠️ **前置条件**：仅当 Phase 3 证明存在 CPU 瓶颈，且以 SSD/NVMe 为主要使用场景时实施。

#### 4.1 评估标准
- 基准测试显示当前为 CPU 瓶颈（如 CRC32、压缩计算）
- 目标硬件以 SSD/NVMe 为主（HDD 上并行 IO 收益有限）

#### 4.2 实现范围（保守策略）
- **Pack**：仅并行 CRC32/压缩计算（CPU 密集型），写入保持串行
- **Unpack**：暂不并行，或仅对解压阶段并行

#### 4.3 技术方案
- 生产者-消费者模型
- task_id + 最小堆保序机制
- 内存限制器防止 OOM

---

## 暂缓需求

以下需求在 Phase 1-3 期间**明确不做**：

1. **并行归档** - 见 Phase 4，需前置条件满足
2. **加密支持** - 超出项目范围
3. **网络传输** - 超出项目范围
4. **多卷归档** - 使用场景有限

---

## 技术约束

- **语言标准**：C++17
- **依赖限制**：优先使用标准库，必要时引入 zlib（CRC32）
- **平台支持**：macOS/Linux，保持可移植性
- **兼容性**：.kar 文件格式向后兼容
